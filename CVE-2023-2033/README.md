https://issues.chromium.org/issues/40061500

https://chromium-review.googlesource.com/c/v8/v8/+/3988924

# Ubercage Sandbox Escapes

We will be going through 

### JIT Spraying/Shellcoding

- This technique is stable on x86_64 based OSes (Windows and some families of Linux) until CPT was introduced, where the code pointers are replaced by indices and only accessible via the code pointer table

- In CVE-2018-17463, we briefly went through the possibility of bypassing W^X protection on JIT-ed functions but did not dive into it due to the fact that we could get away with abusing WASM spaces

- The introduction of W^X protection on WASM spaces did not deter us from continue using it due to the fact that we could still create arbitrary r/w primitives and bitmap flipping the appropriate locations in chrome in order to disable the protection

- In Chrome 103, arraybuffer backingstores were sandboxed and in order to access the backingstore, you would need to find the base location of the v8 sandbox and add it with index*0x100 (as per the [documentation](https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit), this base location is found in r14). Given that in a typical chrome bug, it is unlikely for us to leak this value, we need to be creative in obtaining our RCE.

    ![](./Advent%20of%20Ubercage/Chrome_104.0.5112.81_ArrayBuffer_BackingStore-2.png)

- Looking at how JIT-ed functions work when returning floats, we observe that we can smuggle shellcode inside floats as seen in CVE-2018-17463, we need to note that:

    1. The maximum length of each instruction needs to be lesser or equal to 6 bytes (cause we also need to jump to our next float)

    2. In Windows, where we need to craft Position Independent shellcode, jumping and calling is a pain but still possible

    3. We need to make sure that each float is unique if not V8 will optimise the way the floats are passed around (instead of generating the 8 byte integer, it will simply play around with the float registers with the duplicate values)

- `jit_spraying.py` is a script which will generate the appropriate Uint8Array which we can later convert to a float array

- Here, we are able to bypass the W^X protections implemented without needing any arbitrary r/w primitives

### CVE-2022-4174 on Chrome 103

- We will attempt to exploit Chrome 103 using CVE-2022-4174 which should affect chromium versions prior to Chrome 108